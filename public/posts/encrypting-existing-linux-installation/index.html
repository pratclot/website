<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Encrypting Existing Linux Installation | Orange Days</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="I have an Arch (Gnome) on one physical disk and Ubuntu on another. At some point I decided to encrypt the Ubuntu installation. Ubuntu was just sitting on a simple /dev/nvme1n1p1 partition. I added a separate boot /dev/nvme1n1p2 device to keep grub on, and it had its benefits too. Main bootloader lives on the Arch disk.
I followed the steps on Arch wiki, but during the boot there was no prompt to put password for decryption.">
    <meta name="generator" content="Hugo 0.123.1">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



  
    <link rel="stylesheet" href="/css/custom.css">
  

  
    <link rel="stylesheet" href="/css/center.css">
  

    

    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/posts/encrypting-existing-linux-installation/">
    

    <meta property="og:title" content="Encrypting Existing Linux Installation" />
<meta property="og:description" content="I have an Arch (Gnome) on one physical disk and Ubuntu on another. At some point I decided to encrypt the Ubuntu installation. Ubuntu was just sitting on a simple /dev/nvme1n1p1 partition. I added a separate boot /dev/nvme1n1p2 device to keep grub on, and it had its benefits too. Main bootloader lives on the Arch disk.
I followed the steps on Arch wiki, but during the boot there was no prompt to put password for decryption." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/encrypting-existing-linux-installation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-01T23:38:50+00:00" />
<meta property="article:modified_time" content="2022-11-01T23:38:50+00:00" />

<meta itemprop="name" content="Encrypting Existing Linux Installation">
<meta itemprop="description" content="I have an Arch (Gnome) on one physical disk and Ubuntu on another. At some point I decided to encrypt the Ubuntu installation. Ubuntu was just sitting on a simple /dev/nvme1n1p1 partition. I added a separate boot /dev/nvme1n1p2 device to keep grub on, and it had its benefits too. Main bootloader lives on the Arch disk.
I followed the steps on Arch wiki, but during the boot there was no prompt to put password for decryption."><meta itemprop="datePublished" content="2022-11-01T23:38:50+00:00" />
<meta itemprop="dateModified" content="2022-11-01T23:38:50+00:00" />
<meta itemprop="wordCount" content="724">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Encrypting Existing Linux Installation"/>
<meta name="twitter:description" content="I have an Arch (Gnome) on one physical disk and Ubuntu on another. At some point I decided to encrypt the Ubuntu installation. Ubuntu was just sitting on a simple /dev/nvme1n1p1 partition. I added a separate boot /dev/nvme1n1p2 device to keep grub on, and it had its benefits too. Main bootloader lives on the Arch disk.
I followed the steps on Arch wiki, but during the boot there was no prompt to put password for decryption."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Orange Days
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Encrypting Existing Linux Installation</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-11-01T23:38:50Z">November 1, 2022</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><figure class="center"><img src="/images/encrypting-existing-linux-installation/Screenshot_from_2022_11_03_15_02_35_d5756d2021.png"
         alt="picture of Ubuntu asking for a password to decrypt root disk"/>
</figure>

<p>I have an Arch (Gnome) on one physical disk and Ubuntu on another. At some point I decided to encrypt the Ubuntu installation.
Ubuntu was just sitting on a simple /dev/nvme1n1p1 partition. I added a separate boot /dev/nvme1n1p2 device to keep grub on, and it had its benefits too. Main bootloader lives on the Arch disk.</p>
<p>I followed the steps on Arch wiki, but during the boot there was no prompt to put password for decryption.</p>
<p>Ubuntu uses initramfs, Arch has mkinitcpio, I could not follow the HOOKS part on the wiki. I will describe what worked on Ubuntu.</p>
<ul>
<li>I used Arch to mount the encrypted /dev/nvme1n1p1 device, in Gnome you can use the friendly Disks tool. Notice there are two UUIDs here - for the LUKS container and the actual rootfs. We will need the LUKS one, the second one is used inside /etc/fstab, which is read after the boot and is not related to the decrypting steps here:</li>
</ul>
<p><img src="/images/encrypting-existing-linux-installation/Screenshot_from_2022_10_29_21_39_27_8b7f5b2804.png" alt="Screenshot from 2022-10-29 21-39-27.png"></p>
<ul>
<li>then as root in the terminal run arch-chroot on the mountpoint of the Ubuntu installation (if you are not on Arch, you will need to mount dev, proc and all that manually). I had to also perform PATH setting for some reason:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/bin:/usr/local/sbin:/usr/sbin:/sbin:$PATH
</span></span></code></pre></div><ul>
<li>since the boot partition is separate from rootfs (I chose to not encrypt it), also mount it:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@msi:/# mount /dev/nvme1n1p2 /boot
</span></span></code></pre></div><ul>
<li>Ubuntu provides update-initramfs script which will gather information from /etc/crypttab and /etc/fstab to be able to find your rootfs at boot. So you only have to put correct entries there:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@msi:/# cat /etc/crypttab 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;target name&gt;	&lt;source device&gt;		&lt;key file&gt;	&lt;options&gt;</span>
</span></span><span style="display:flex;"><span>cryptroot UUID<span style="color:#f92672">=</span>97ee223b-4db7-4bf4-a9a2-0e5a2c64861f none luks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@msi:/# cat /etc/fstab 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/fstab: static file system information.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use &#39;blkid&#39; to print the universally unique identifier for a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># device; this may be used with UUID= as a more robust way to name devices</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># that works even if disks are added and removed. See fstab(5).</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># / was on /dev/nvme0n1p1 during installation</span>
</span></span><span style="display:flex;"><span>UUID<span style="color:#f92672">=</span>4756df54-5536-4001-bc12-046572ed6bd1 /               ext4    errors<span style="color:#f92672">=</span>remount-ro <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>/swapfile                                 none            swap    sw              <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>/dev/disk/by-uuid/bf2e4087-13be-4453-aea1-24b33b54b64a /boot auto nosuid,nodev,nofail,x-gvfs-show <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><ul>
<li>(optional) I also changed /etc/cryptsetup-initramfs/conf-hook, but probably that was not required:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@msi:/# grep CRYPTSETUP /etc/cryptsetup-initramfs/conf-hook
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CRYPTSETUP: [ y | n ]</span>
</span></span><span style="display:flex;"><span>CRYPTSETUP<span style="color:#f92672">=</span>y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Setting KEYFILE_PATTERN to a non-empty value implies &#34;CRYPTSETUP=y&#34;.</span>
</span></span></code></pre></div><ul>
<li>generate initramfs for the current kernel:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@msi:/# update-initramfs -u
</span></span></code></pre></div><ul>
<li>now tell grub about that cryptroot entry (you can change the name if you do not like it):</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@msi:/# grep GRUB_CMDLINE_LINUX /etc/default/grub
</span></span><span style="display:flex;"><span>GRUB_CMDLINE_LINUX_DEFAULT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;quiet splash nvidia-drm.modeset=1 bluetooth.disable_ertm=1&#34;</span>
</span></span><span style="display:flex;"><span>GRUB_CMDLINE_LINUX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cryptdevice=UUID=97ee223b-4db7-4bf4-a9a2-0e5a2c64861f:cryptroot root=/dev/mapper/cryptroot&#34;</span>
</span></span></code></pre></div><ul>
<li>update grub:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@msi:/# update-grub
</span></span></code></pre></div><ul>
<li>done</li>
</ul>
<h3 id="helpful-tips">Helpful tips</h3>
<p>I used a virtual machine on Arch to test Ubuntu installation ( Virtual Machine Manager is quite helpful). I used PCI passthrough to have the whole physical disk there. It is extremely handy to have that environment and I highly recommend doing that at all times (even on Windows with Hyper-V).</p>
<p>This way I was also able to test the second grub installation. Now even if Arch boot device dies, I still can go (hopefully) to Ubuntu because it has a separate boot partition. You can chain Arch&rsquo;s grub to Ubuntu&rsquo;s one like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>       insmod chain
</span></span><span style="display:flex;"><span>       search --no-floppy --fs-uuid --set<span style="color:#f92672">=</span>root bf2e4087-13be-4453-aea1-24b33b54b64a
</span></span><span style="display:flex;"><span>       configfile /grub/grub.cfg
</span></span></code></pre></div><p>These are the directives for the grub config file, UUID is that of /dev/nvme1n1p2, where my second grub lives.</p>
<p>I used Grub Customizer on Arch to add another boot entry to its grub:</p>
<p><img src="/images/encrypting-existing-linux-installation/Screenshot_from_2022_11_01_23_47_53_e58058e5a4.png" alt="Screenshot from 2022-11-01 23-47-53.png"></p>
<p>When grub loads misconfigured initramfs you drop into shell:</p>
<p>-picture of shell-</p>
<p>Sometimes it says what&rsquo;s up, sometimes not. If you type exit it will try to boot again and will hopefully show the error. In my case it could not find /dev/mapper/cryptroot that was declared as root by grub.</p>
<p>You can try to figure out what happens in initramfs to get you to your rootfs. I understood that it probably is not overly complicated. There is switch_root tool that is likely used at the very end of all when the rootfs is mounted and accessible. The device decryption happens with cryptsetup luksOpen. So once I ended up in the shell I ran this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cryptsetup luksOpen /dev/nvme0n1p1 cryptroot
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div><p>And it immediately booted Ubuntu. Note that cryptsetup was not available until update-initramfs was able to see proper /etc/crypttab (or something similar that it relies on). I guess the equivalent configuration on Arch is done by mkinitcpio&rsquo;s HOOKS section.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://localhost:1313/" >
    &copy;  Orange Days 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
